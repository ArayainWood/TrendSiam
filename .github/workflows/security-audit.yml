# ====================================================================
# Security Audit Workflow - TrendSiam
# ====================================================================
# Runs security scans on pull requests and scheduled weekly audits
# 
# DO NOT PUSH THIS FILE TO REMOTE (per Playbook rules)
# This is a local reference for future CI/CD setup
# ====================================================================

name: Security Audit

# Trigger conditions
on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
      - 'requirements.txt'
      - '.github/workflows/security-audit.yml'
  
  schedule:
    # Weekly audit every Monday at 08:00 UTC (15:00 Bangkok)
    - cron: '0 8 * * 1'
  
  workflow_dispatch:  # Allow manual trigger

# ====================================================================
# JOBS
# ====================================================================

jobs:
  # ==================================================================
  # NPM Security Audit (Frontend)
  # ==================================================================
  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run npm audit
        working-directory: frontend
        run: |
          npm audit --production --audit-level=moderate
          echo "✅ NPM audit passed"
      
      - name: Save audit report
        if: failure()
        working-directory: frontend
        run: |
          npm audit --json > ../reports/repo/npm-audit-ci-$(date +%Y%m%d).json
          npm audit > ../reports/repo/npm-audit-ci-$(date +%Y%m%d).txt
      
      - name: Upload audit artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-reports
          path: reports/repo/npm-audit-ci-*.txt
          retention-days: 30
  
  # ==================================================================
  # PIP Security Audit (Backend)
  # ==================================================================
  pip-audit:
    name: PIP Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: requirements.txt
      
      - name: Install pip-audit
        run: pip install pip-audit
      
      - name: Run pip-audit
        run: |
          pip-audit --requirement requirements.txt --format text
          echo "✅ PIP audit passed"
        continue-on-error: true  # Don't fail if hash mismatches (known issue)
      
      - name: Save audit report
        if: always()
        run: |
          pip-audit --requirement requirements.txt --format json > reports/repo/pip-audit-ci-$(date +%Y%m%d).json || true
          pip-audit --requirement requirements.txt --format text > reports/repo/pip-audit-ci-$(date +%Y%m%d).txt || true
      
      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-reports
          path: reports/repo/pip-audit-ci-*.txt
          retention-days: 30
  
  # ==================================================================
  # Gitleaks Secret Scanning
  # ==================================================================
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Note: GITLEAKS_LICENSE removed to avoid linter warnings
          # If you have a Gitleaks Pro license, add it manually as a repository secret
        with:
          args: --config=.gitleaksignore
      
      - name: Upload Gitleaks report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30
  
  # ==================================================================
  # TypeScript Type Check
  # ==================================================================
  typescript:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run TypeScript check
        working-directory: frontend
        run: |
          npm run type-check
          echo "✅ TypeScript check passed"
  
  # ==================================================================
  # ESLint Code Quality
  # ==================================================================
  eslint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run ESLint
        working-directory: frontend
        run: |
          npm run lint
          echo "✅ ESLint passed"
  
  # ==================================================================
  # DB Object Smoke Test
  # ==================================================================
  db-smoke-test:
    name: DB Object Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run DB validation script
        working-directory: frontend
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || '' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || '' }}
        run: |
          if [ -n "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
            node ../scripts/validate-db-objects.js
            echo "✅ DB object validation passed"
          else
            echo "⚠️  Skipping DB validation (no credentials)"
          fi
        continue-on-error: true  # Don't fail CI if DB not available
      
      - name: Upload validation report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: db-validation-report
          path: reports/db/validation-*.txt
          retention-days: 30
  
  # ==================================================================
  # Summary Report
  # ==================================================================
  summary:
    name: Security Audit Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, pip-audit, gitleaks, typescript, eslint, db-smoke-test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PIP Audit | ${{ needs.pip-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.eslint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DB Smoke Test | ${{ needs.db-smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY

# ====================================================================
# NOTES
# ====================================================================
# - This workflow is designed for GitHub Actions
# - Adjust paths and commands for your specific environment
# - Consider adding Slack/email notifications for failures
# - Enable branch protection rules to require these checks
# - Review security reports weekly in team meetings
# ====================================================================

# END OF WORKFLOW

