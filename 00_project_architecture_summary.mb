# 00_project_architecture_summary

This document provides a comprehensive architectural overview of the TrendSiam project for understanding its structure without reading raw source code.

## High-Level Overview

**Project Purpose:** TrendSiam is an AI-powered Thai trend/news intelligence platform that aggregates trending content from YouTube and X (Twitter), provides Thai/English summaries, classifies content, scores popularity, and generates weekly PDF reports with AI-generated images for top stories.

**Primary Technologies:**
- **Frontend:** Next.js 14 (App Router), TypeScript, React 18, Tailwind CSS
- **Backend:** Python 3.x for data ingestion, Supabase (PostgreSQL) for database
- **Database:** Supabase (hosted PostgreSQL) in SEA region (Singapore)
- **AI/ML:** OpenAI API for summaries and image generation
- **PDF Generation:** @react-pdf/renderer with Thai font support
- **State Management:** Zustand
- **Data Fetching:** Supabase JS Client, native fetch API
- **Styling:** Tailwind CSS with custom Thai-inspired design system
- **Testing:** TypeScript for type safety, various test scripts

## Directory Structure

### Root Level Directories

- **`/frontend`** - Next.js application (main user-facing app)
  - `/src/app` - Next.js App Router pages and API routes
  - `/src/components` - Reusable React components  
  - `/src/lib` - Business logic, utilities, and data access
  - `/src/stores` - Zustand state management
  - `/db/sql` - SQL migrations and view definitions
  - `/scripts` - Build and maintenance scripts

- **`/memory-bank`** - Project documentation and knowledge base (.mb files)
  - Contains critical project context, rules, and operational procedures

- **`/docs`** - Technical documentation and runbooks
  - Playbook 2.0 documentation
  - Security guidelines
  - Migration guides

- **`/scripts`** - Python scripts for data validation and maintenance
  - Database schema inspection
  - Security audits
  - Data quality checks

- **`/tests`** - Python test files for backend functionality

- **`/utils`** - Shared Python utilities

- **`/core`** - Core Python modules (if present)

### Key Python Scripts (Root Level)
- `summarize_all_v2.py` - Main data ingestion pipeline
- `ai_image_generator_v2.py` - AI image generation for top stories
- `app.py` - Legacy Flask application (if still used)
- Various validation and fix scripts

## Application Routing (Next.js App Router)

### User-Facing Pages

1. **`/` (Home Page)** - `src/app/page.tsx`
   - **Purpose:** Main trending stories feed with Top-3 featured stories
   - **Type:** Client Component
   - **Features:** Real-time updates, filtering, dark mode, Thai/English toggle

2. **`/weekly-report`** - `src/app/weekly-report/page.tsx`
   - **Purpose:** Weekly trending report interface
   - **Type:** Client Component with server data fetching
   - **Features:** PDF download, weekly statistics, historical data

3. **`/enhanced-home`** - `src/app/enhanced-home/page.tsx`
   - **Purpose:** Enhanced version of home page (experimental)
   - **Type:** Client Component

4. **`/dev-dashboard`** - `src/app/dev-dashboard/page.tsx`
   - **Purpose:** Developer dashboard for monitoring
   - **Type:** Client Component (dev-only)

5. **`/legal`** - `src/app/legal/page.tsx`
   - **Purpose:** Legal information page
   - **Type:** Server Component

6. **`/privacy`** - `src/app/privacy/page.tsx`
   - **Purpose:** Privacy policy page
   - **Type:** Server Component

7. **`/terms`** - `src/app/terms/page.tsx`
   - **Purpose:** Terms of service page
   - **Type:** Server Component

8. **`/supabase-test`** - `src/app/supabase-test/page.tsx`
   - **Purpose:** Database connection testing (dev-only)
   - **Type:** Client Component

### API Routes

#### Core Data APIs
- **`/api/home`** - Main news feed endpoint (uses public_v_home_news view)
- **`/api/home/diagnostics`** - Home feed diagnostics and health check
- **`/api/weekly`** - Weekly report data endpoint
- **`/api/weekly/pdf`** - PDF generation for weekly reports (Node runtime)
- **`/api/snapshots`** - Snapshot data access

#### Health & Monitoring
- **`/api/health`** - General health check
- **`/api/health/db`** - Database health check
- **`/api/ping`** - Simple ping endpoint
- **`/api/db-health`** - Detailed database health

#### Developer Tools
- **`/api/dev/db-inventory`** - Database schema inventory
- **`/api/diagnostics/views`** - Database view diagnostics
- **`/api/diagnostics/ai-prompts`** - AI prompt diagnostics
- **`/api/env-check`** - Environment variable validation

#### Weekly Report Management
- **`/api/weekly/build-snapshot`** - Build weekly snapshot
- **`/api/weekly/check-update`** - Check for updates
- **`/api/weekly/data`** - Weekly data access
- **`/api/weekly/diagnostics`** - Weekly report diagnostics

#### System & Admin
- **`/api/admin/revalidate`** - Cache revalidation
- **`/api/system-meta`** - System metadata access
- **`/api/test-plan-b`** - Security model testing

## Core UI Components

### News Display Components
1. **`NewsCard`** (`src/components/news/NewsCard.tsx`)
   - Displays individual news stories with popularity scores, engagement metrics, and AI images

2. **`NewsGrid`** (`src/components/news/NewsGrid.tsx`)
   - Grid layout container for news cards with responsive design

3. **`NewsDetailModal`** (`src/components/news/NewsDetailModal.tsx`)
   - Modal for detailed story view with full content and metadata

4. **`TopStoryCard`** (`src/components/news/TopStoryCard.tsx`)
   - Special card design for top 3 trending stories with prominent images

5. **`EnhancedNewsCard`** (`src/components/news/EnhancedNewsCard.tsx`)
   - Enhanced version with additional features (experimental)

### Layout Components
6. **`Navigation`** (`src/components/layout/Navigation.tsx`)
   - Main navigation bar with Thai/English toggle and theme switcher

7. **`Footer`** (`src/components/layout/Footer.tsx`)
   - Footer with statistics, links, and AI image counter

8. **`Layout`** (`src/components/layout/Layout.tsx`)
   - Main layout wrapper component

### Utility Components
9. **`HeroSection`** (`src/components/hero/HeroSection.tsx`)
   - Hero section for landing page with featured content

10. **`FilterPanel`** (`src/components/filters/FilterPanel.tsx`)
    - Category and platform filtering controls

## Data Layer & Flow (Supabase)

### Database Tables

1. **`news_trends`** - Main table for trending items
   - Stores aggregated trending data from all platforms
   - Contains title, summary, scores, metadata

2. **`stories`** - Canonical story records  
   - Stable story tracking across time
   - Links to platform-specific IDs

3. **`snapshots`** - Time-series engagement data
   - Tracks view/like/comment counts over time
   - Used for growth rate calculations

4. **`ai_images`** - AI-generated images for Top-3
   - Stores image URLs and generation prompts
   - Links to news_trends via news_id

5. **`system_meta`** - System configuration
   - Stores config like home_limit, top3_max
   - Tracks last update timestamps

6. **`weekly_report_snapshots`** - Weekly report data
   - Pre-computed weekly summaries
   - Used for PDF generation

### Public Views (Plan-B Security)

All frontend access goes through secure public views:

1. **`public_v_home_news`** - Main home feed view
   - 26 columns with aliasing for backward compatibility
   - Implements 72h primary / 30d fallback freshness policy
   - Top-3 image policy enforcement

2. **`public_v_system_meta`** - Safe system metadata
   - Exposes only allowed keys (home_limit, top3_max, etc.)
   - No sensitive configuration exposed

3. **`public_v_ai_images_latest`** - Bridge view for AI images
   - Latest image per news item
   - Prevents permission errors on base tables

### Data Flow

1. **Ingestion Pipeline:**
   ```
   YouTube/X APIs → summarize_all_v2.py → news_trends/stories/snapshots tables
   ```

2. **AI Image Generation:**
   ```
   Top-3 stories → ai_image_generator_v2.py → ai_images table → Supabase Storage
   ```

3. **Frontend Data Access:**
   ```
   Next.js API Routes → Supabase Client (anon key) → public_v_* views → UI Components
   ```

4. **Weekly Report:**
   ```
   Snapshot builder → weekly_report_snapshots → PDF generator → User download
   ```

## Backend Logic & Scheduled Jobs

### Data Ingestion Scripts

1. **`summarize_all_v2.py`** - Main pipeline
   - Fetches trending data from YouTube/X APIs
   - Generates AI summaries (Thai/English)
   - Calculates popularity scores
   - Updates database with new data
   - Triggers: Manual or scheduled (cron)

2. **`ai_image_generator_v2.py`** - Image generation
   - Generates AI images for Top-3 stories only
   - Uses OpenAI DALL-E API
   - Uploads to Supabase Storage
   - Maintains image persistence

3. **`youtube_fetcher.py`** - YouTube data fetcher
   - Uses yt-dlp for trending videos
   - Extracts metadata and engagement metrics

### Scheduled Jobs

Currently managed externally (not in Supabase Edge Functions):
- Daily data ingestion (typically run via cron)
- Weekly snapshot building for reports
- No built-in Supabase Edge Functions detected

### Maintenance Scripts

- **Database validation:** Various SQL scripts in `/scripts/sql`
- **Security audits:** `security_audit.py`, `security_audit_comprehensive.py`
- **Data quality:** `check_pipeline_health.py`, `verify_score_details_pipeline.py`

## Environment Configuration

### Required Environment Variables (Names Only)

#### Frontend (Next.js)
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase anonymous key
- `NEXT_PUBLIC_BASE_URL` - Base URL for the application

#### Backend (Python Scripts)
- `SUPABASE_URL` - Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key (backend only)
- `YOUTUBE_API_KEY` - YouTube Data API key
- `OPENAI_API_KEY` - OpenAI API key for AI features

#### Optional
- `ALLOW_JSON_FALLBACK` - Allow fallback to JSON files
- `NODE_ENV` - Environment (development/production)

### Security Notes

- Frontend uses only `anon` key (never service role)
- Service role key restricted to backend scripts
- All frontend data access through public views only
- Plan-B security model strictly enforced

## Key Architectural Decisions

1. **Security-First Design:** Plan-B security model with view-only access
2. **Bilingual Support:** Full Thai/English throughout the stack
3. **AI Image Policy:** Only Top-3 stories get AI-generated images
4. **Snapshot-Based Freshness:** 72-hour primary window with 30-day fallback
5. **PDF Generation:** Node.js runtime with Thai font embedding
6. **No Edge Functions:** Backend logic runs as scheduled scripts, not Supabase Edge Functions
7. **Idempotent Pipeline:** Re-runs don't destroy historical data

This architecture supports TrendSiam's goal of providing quality-first, legally compliant Thai trend intelligence with strong security, performance, and user experience.
