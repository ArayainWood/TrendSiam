#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook: Final safety check before pushing to remote

echo "üîí Pre-push security check..."

# Block push if .env.local is tracked
if git ls-files | grep -E "\.env\.local$"; then
  echo ""
  echo "‚ùå CRITICAL: .env.local files are tracked in git!"
  echo ""
  echo "   This is a SECURITY VIOLATION."
  echo "   .env.local files must NEVER be in git history."
  echo ""
  echo "   To fix:"
  echo "   1. Remove from tracking: git rm --cached **/.env.local"
  echo "   2. Verify .gitignore includes: .env.local"
  echo "   3. If already committed: Contact team lead for history cleanup"
  echo ""
  exit 1
fi

# Verify frontend/.env.local exists locally (not pushing it, just checking dev env is intact)
if [ ! -f "frontend/.env.local" ]; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: frontend/.env.local is missing!"
  echo ""
  echo "   While you can push without it, your local dev environment"
  echo "   won't work until you restore this file."
  echo ""
  echo "   After push, copy from frontend/env.example and fill in values."
  echo ""
fi

# Block push to main/master without explicit approval
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo ""
  echo "‚ö†Ô∏è  Pushing to $CURRENT_BRANCH branch."
  echo ""
  echo "   This is the production branch."
  echo "   Ensure all tests pass and changes are reviewed."
  echo ""
  # Note: We warn but don't block, as user may have legitimate need
fi

# Run full gitleaks scan on all commits being pushed
if command -v gitleaks >/dev/null 2>&1; then
  echo "üîç Running gitleaks scan on commits to be pushed..."
  gitleaks detect --source . --verbose --redact
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Gitleaks detected secrets in repository!"
    echo "   DO NOT PUSH until secrets are removed."
    echo "   Contact security team for history cleanup if needed."
    echo ""
    exit 1
  fi
fi

echo "‚úÖ Pre-push checks passed!"
echo "   Pushing to $CURRENT_BRANCH..."
