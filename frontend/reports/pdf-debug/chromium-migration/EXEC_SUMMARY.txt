PDF CHROMIUM MIGRATION - EXECUTIVE SUMMARY
==========================================
Date: 2025-10-20
Status: Phase 0 - Discovery & Baseline

SCOPE
-----
Replace the current @react-pdf/renderer pipeline with a Chromium (HarfBuzz-backed) HTML→PDF pipeline 
to resolve persistent Thai/CJK/Emoji rendering issues that cannot be fixed in the current architecture.

CURRENT PAIN POINTS
-------------------
1. Thai Diacritic Issues (70% improved but not eliminated)
   - SARA AA (า) removal bug fixed in sanitizer
   - Line height/padding increased (1.65/3px) 
   - Still experiencing diacritic clipping in dense clusters

2. Complex Title Corruption (Item #20: "Trailer=@")
   - Root cause: @react-pdf/renderer lacks HarfBuzz
   - Grapheme clusters split during wrap/trim
   - Punctuation misinterpreted as combining marks
   - NOT FIXABLE with current renderer

3. Mixed Script Issues
   - Font selector desync fixed
   - Korean/CJK fonts now registered properly
   - But spacing/kerning still differs from browser

4. Architecture Limitations
   - No HarfBuzz integration = No proper OpenType shaping
   - No grapheme-aware wrapping = Cluster splitting
   - Requires 500+ lines of sanitizer workarounds
   - Each fix creates new edge cases

MIGRATION ARCHITECTURE
----------------------
Current: Snapshot data → React components → @react-pdf/renderer → PDF
Target:  Snapshot data → React/HTML template → Playwright/Puppeteer → Chromium print-to-PDF
                                                ↑ (HarfBuzz-backed, full OpenType)

KEY REQUIREMENTS
----------------
1. Pixel-match to web UI
2. Correct Thai/CJK/Emoji shaping  
3. Zero diacritic clipping/overlap
4. Feature flag for safe rollout
5. Self-hosted fonts (no OS dependencies)
6. Playbook/Plan-B security compliance

PHASES
------
Phase 0: Discovery & Baseline (Current)
Phase 1: Snapshot Data Contract
Phase 2: React/HTML Template for Print
Phase 3: Chromium Engine (Playwright)
Phase 4: Verification (A/B and Pixel Diff)
Phase 5: Rollout & Cleanup

DELIVERABLES
------------
- New /api/pdf2 route with Chromium engine
- Feature flags: pdf.chromium.enabled, pdf.legacy.enabled
- Health endpoints for monitoring
- Pixel-diff test suite
- Updated Memory Bank documentation
- Operational runbook

SUCCESS CRITERIA
----------------
1. Item #20: No "Trailer=@" corruption
2. Thai diacritics: Zero clipping/overlap
3. Mixed scripts: Pixel-perfect rendering
4. Performance: <7s generation time
5. File size: <100KB for 20 items

RISK MITIGATION
---------------
- Feature flags for gradual rollout
- Legacy route preserved as fallback
- Comprehensive test suite before cutover
- Rollback plan documented

END OF EXECUTIVE SUMMARY
