• Homepage DoD:
  • After running: python summarize_all_v2.py --limit 20 --verbose --force-refresh-stats
  • Frontend shows ≥20 stories for "today" (Thai time). Top-3 have images + scores. Source links valid.
  • DB query by view's summary_local_date matches UI count (±1 allowed if filters differ).
• PDF DoD:
  • Node runtime, no edge. Fetches from Supabase (no JSON fallback). Returns Buffer with correct headers.
  • Downloads in <8s on local/staging. Thai fonts render correctly. Content = latest data.
• X Compare DoD (MVP):
  • Ingests a small set from X, stores safely, and the homepage displays "Both / YouTube-only / X-only" correctly (hide empty sections).
• Auth+Gate DoD:
  • User can sign up/sign in; downloading PDF requires login. Free gets basic PDF; upgrade page visible.
• AI Video DoD (MVP):
  • At least one working 30–45s vertical video generated using Top-3 AI images + Thai TTS + "AI-generated" label.
• Home View Verification (verify_home_view.sql):
  • View exists check: view_exists = true (public.public_v_home_news must exist)
  • Row count: total_rows >= 1 (or 0 with clear fallback reason if pipeline hasn't run)
  • Column contract: No "missing" columns, no "unexpected" columns (26 columns expected)
  • Type assertions: growth_rate_value_is_numeric = true, growth_rate_label_is_text = true
  • System meta keys: home_limit, top3_max available (news_last_updated optional)
• Diagnostics (public views only):
  • APIs must NEVER read base tables (news_trends, stories, snapshots) with anon key
  • Use public_v_home_news for all news data queries
  • Use public_v_system_meta for config values (home_limit, top3_max, news_last_updated)
  • Expected diagnostics response: success=true, fetchedCount, missingColumns=[], meta object
  • No "permission denied" errors should occur when properly using views

## Snapshot-based Freshness Tests (Added 2025-09-23):
• SQL quick checks (after migration):
  • SELECT COUNT(*) FROM public.public_v_home_news; -- Should return ≥0
  • SELECT COUNT(*) FROM snapshots WHERE snapshot_date >= now() - interval '72 hours'; -- Check primary window
  • SELECT COUNT(*) FROM snapshots WHERE snapshot_date >= now() - interval '30 days'; -- Check fallback window
  • SELECT id, COUNT(*) FROM public.public_v_home_news GROUP BY id HAVING COUNT(*)>1; -- Must return 0 rows
• API/UX checks:
  • /api/home/diagnostics → success:true, missingColumns: [], includes home_freshness_policy = 'latest_snapshot:72h_primary|30d_fallback'
  • /api/home → { success:true, fetchedCount >= 0 } (if snapshots exist → > 0)
  • Home page renders; Top-3 show images/prompts; others don't
• Script verification:
  • Run: node frontend/scripts/verify-home-contract.mjs → exit code 0
  • Run: psql -f frontend/db/sql/checks/home_view_integrity.sql → all checks pass
• Acceptance (must meet all):
  • Home feed populated by still-trending stories (by latest snapshot), regardless of publish date
  • No changes to scoring, ranking fields, storage, or historical data
  • No missing images due to COALESCE and Top-3 policy
  • Zero TS/lint/runtime errors; no regressions on other pages
  • Diagnostics clean; permissions clean (views-only)
  • Contract integrity (26 columns) verified by scripts

## SQL Migration Order & Fixes (Updated 2025-09-23 - Definer Model):
• Migration files location: frontend/db/sql/fixes/
• Run order in Supabase SQL Editor (must execute with zero errors):
  1. 2025-09-23_public_v_system_meta.sql (create/recreate system meta view)
  2. 2025-09-23_revoke_system_meta_base_table_select_from_anon.sql (revoke system_meta base grants)
  3. 2025-09-23_public_v_ai_images_latest.sql (create bridge view if not exists)
  4. 2025-09-23_recreate_public_v_home_news_definer.sql (recreate as definer view)
  5. 2025-09-23_revoke_base_table_select_from_anon.sql (revoke all base table grants)
  6. 2025-09-23_upsert_home_policy.sql (fixed to use only key/value/updated_at)
  7. 2025-09-17_grant_public_v_home_news.sql (re-apply to ensure grants)
  8. verify_home_contract_26.sql (verify 26-column contract)
  9. verify_view_only_permissions.sql (verify no base table access)
  10. verify_permissions_model.sql (comprehensive verification)
• Key fixes applied:
  - Definer security: public_v_home_news now uses definer (not invoker) security
  - Bridge view pattern: public_v_ai_images_latest exposes only latest image per news_id
  - Home view joins bridge view, NOT base ai_images table (no permission errors)
  - Base table security: REVOKED all SELECT grants from anon/authenticated on base tables
  - system_meta upserts use only existing columns (no description/created_at)
  - Security barrier: Views use security_barrier = true for extra protection
  - NO grants on base tables to anon/authenticated roles (enforced by revoke script)
• Quick verification queries (run after all migrations):
  ```sql
  -- View returns data if snapshots exist
  SELECT COUNT(*) FROM public.public_v_home_news;
  
  -- No duplicate stories
  SELECT id, COUNT(*) FROM public.public_v_home_news 
  GROUP BY id HAVING COUNT(*) > 1;
  
  -- Metadata view works
  SELECT * FROM public.public_v_system_meta 
  WHERE key IN ('home_freshness_policy', 'home_limit', 'top3_max');
  
  -- Confirm policy was upserted
  SELECT key, value, updated_at FROM system_meta 
  WHERE key = 'home_freshness_policy';
  
  -- Verify bridge view
  SELECT COUNT(*) FROM public.public_v_ai_images_latest;
  
  -- Check permissions (should be empty - no base table grants)
  SELECT grantee, privilege_type FROM information_schema.role_table_grants
  WHERE table_schema = 'public' AND table_name = 'ai_images' 
  AND grantee IN ('anon', 'authenticated');
  ```
• Verification script: Run verify_permissions_home_ai.sql for comprehensive checks
• Never reference non-existent columns; always verify table schema first
• Never grant SELECT on base tables to anon/authenticated roles

## Views-Only Security Model (Critical):
• Frontend with anon key must ONLY access public_v_* views
• Base tables (news_trends, stories, snapshots, ai_images, system_meta) are completely off-limits
• All views use either definer security (can read base tables) or bridge pattern
• No base-table access guard: Script at frontend/scripts/check-view-only-access.js
• If "permission denied" occurs, check:
  1. Is the code trying to access a base table? → Use the corresponding public_v_* view
  2. Does the public view exist? → Run the creation SQL
  3. Does the view have proper grants? → Run grant SQL
  4. Are there leftover base table grants? → Run revoke SQL

## SQL Change Acceptance Criteria (Added 2025-09-30: psql-runner):
• Preflight analysis phase:
  • Run: npm run db:preflight <sql-file> → Must identify all DDL operations
  • All objects must be schema-qualified (public.table_name)
  • High-risk operations (DROP, ALTER COLUMN) flagged with suggestions
  • Exit code 0 = safe to proceed; non-zero = fix issues first
• Dry-run phase:
  • Run: npm run db:dry -- --file <sql-file> → Wraps in BEGIN/ROLLBACK
  • No actual changes made to database
  • Validates SQL syntax and permissions
  • Lock/statement timeouts enforced (5s/30s defaults)
• Real execution phase:
  • Run: npm run db:exec -- --file <sql-file> → Single transaction with ON_ERROR_STOP
  • Automatic rollback on any error
  • Masked credential logging to scripts/db/logs/
  • Production requires: --env prod --yes "I know what I'm doing"
• Post-verification phase:
  • Run: npm run db:verify <sql-file> → Re-introspects created objects
  • Verifies existence, types, permissions (SELECT for anon/authenticated on views)
  • Tests view selectability (SELECT 1 FROM view LIMIT 1)
  • Records migration in schema_migrations table with checksum
• Complete workflow:
  • Run: npm run db:run <sql-file> → Runs all phases in sequence
  • Stops on first failure with clear error message
  • Use --dry-only flag to skip real execution
  • Use --skip-preflight or --skip-verify with extreme caution

## Further Reading
- docs/DB_AUTOMATION_PLAYBOOK.md (comprehensive database automation standard)
- memory-bank/00_db_automation_standard.mb (DB automation quick reference)
- memory-bank/03_frontend_homepage_freshness.mb (API implementation patterns)
- memory-bank/01_security_plan_b.mb (security model)